<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uni.mapper.uni_workplaceMapper">


	<resultMap type="com.uni.domain.uni_workplace_iVO"
		id="leaseMap">
		<id property="ino" column="ino" />
		<result property="title" column="title" />
		<result property="location" column="location" />
		<result property="thumbnail" column="thumbnail" />
		<result property="comforts" column="comforts" />
		<result property="price" column="price" />
		<result property="context" column="context" />
		<result property="rDate" column="rDate" />
		<result property="mno" column="mno" />
		<result property="readCount" column="readCount" />
		<collection property="attachList" resultMap="photoMap">
		</collection>
	</resultMap>

	<resultMap type="com.uni.domain.uni_PhotoVO" id="photoMap">
		<result property="pno" column="pno" />
		<result property="path" column="path" />
		<result property="uuid" column="uuid" />
		<result property="fileName" column="fileName" />
		<result property="ino" column="ino" />
		<result property="sno" column="sno" />
	</resultMap>

	<insert id="insertWorkPlace_i">
		<selectKey keyProperty="ino" order="BEFORE" resultType="int">
			select uni_workplace_i_seq.nextval from dual
		</selectKey>
		insert into uni_workplace_i (ino, title, location, thumbnail,
		comforts, price, context, rDate, mno, readcount)
		values(#{ino},
		#{title}, #{location}, #{thumbnail}, #{comforts}, #{price},
		#{context}, sysdate, #{mno}, 0)
	</insert>

	<select id="read" resultMap="leaseMap">
		select *
		from uni_workplace_I i , uni_photo p
		where i.ino = p.ino and i.ino = #{ino}
	</select>

	<insert id="insertAttach">
		insert into uni_photo (pno, path, uuid, filename,
		ino)
		values(uni_photo_seq.nextval, #{path}, #{uuid}, #{fileName},
		#{ino})
	</insert>

	<update id="updateWorkPlace_i">
		update uni_workplace_i set title = #{title}, location = #{location},
		thumbnail = #{thumbnail}, comforts = #{comforts}, price = #{price}
		where ino = #{ino}
	</update>

	<delete id="deletePhoto">
		delete from uni_photo where ino =#{ino}
	</delete>



	<select id="workPlaceList"
		resultType="com.uni.domain.uni_workplace_iVO">
		select * from uni_workplace_i
	</select>

	<!-- 임대 작업실 검색 -->
	<select id="workPlaceList_i"
		resultType="com.uni.domain.IWorkPlaceVO">
		select * from uni_workplace_i
		where location like
		'%'||#{location}||'%' order by ino
	</select>

	<!-- 공유 작업실 검색 -->
	<select id="workPlaceList_s"
		resultType="com.uni.domain.SWorkPlaceVO">
		select * from uni_workplace_s
		where location like
		'%'||#{location}||'%' order by sno
	</select>

	<!-- 임대 작업실에 대한 평균 별점 -->
	<select id="avg_star_i" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.ino, i.location from uni_review r join
		uni_workplace_i i on r.ino
		=
		i.ino where i.location like
		'%'||#{location}||'%'
		group by r.ino,
		i.location order by r.ino
	</select>

<!-- 공유 작업실에 대한 평균 별점 -->
	<select id="avg_star_s" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.sno, s.location from uni_review r join
		uni_workplace_s s on r.sno
		=
		s.sno where s.location like '%'||#{location}||'%' group by r.sno,
		s.location order by r.sno
	</select>

	<!-- 공유 핫토픽 -->
	<select id="readHotTopic"
		resultType="com.uni.domain.uni_hotTopicVO">

		select round(avg(r.star)) as star, m.name, m.photo,
		w.context,w.thumbnail from
		uni_workplace_s w,uni_review r, uni_member m
		where w.sno = r.sno and
		m.mno = r.mno group by w.sno, w.readcount,
		m.name, m.photo, w.context,
		w.thumbnail order by w.readcount desc

	</select>
	<!-- 임대 핫토픽 -->
	<select id="readHotTopicImde"
		resultType="com.uni.domain.uni_hotTopicVO">

		select round(avg(r.star)) as star, m.name, m.photo,
		w.context, w.thumbnail
		from
		uni_workplace_i w, uni_review r, uni_member
		m where w.ino = r.ino and
		m.mno = r.mno group by w.ino, w.readcount,
		m.name, m.photo,
		w.context,w.thumbnail order by w.readcount desc

	</select>

	<select id="sinchung_list_s"
		resultType="com.uni.domain.Sinchung_ListVO">
	<![CDATA[
		select aa.*, ss.reservation, ss.mno from (select w.title,
		m.name, m.phone, s.sno
		from uni_sinchung s, uni_member m,
		uni_workplace_s w where w.sno
		= s.sno
		and m.mno = s.mno and flag='d'  order by s.sno asc)
		aa,
		(select s.reservation, s.sno, m.mno
		from uni_sinchung s, uni_member
		m, uni_workplace_s w where w.sno =
		s.sno
		and m.mno = s.mno and flag='s'
		and m.mno = #{mno}  order by s.sno asc) ss
		where aa.sno= ss.sno and rownum<4
		]]>
	</select>

	<select id="sinchung_list_d"
		resultType="com.uni.domain.Sinchung_ListVO">
	<![CDATA[
		select aa.*, ss.mno from (select w.title, m.name, m.phone,
		s.sno,
		s.reservation
		from uni_sinchung s, uni_member m, uni_workplace_s
		w
		where w.sno = s.sno
		and m.mno = s.mno and flag='d' and m.mno = #{mno}
		order by s.sno asc)
		aa,
		(select
		s.reservation, s.sno, m.mno
		from
		uni_sinchung s, uni_member
		m,
		uni_workplace_s w where w.sno = s.sno
		and
		m.mno = s.mno and flag='s' order by s.sno asc)
		ss
		where aa.sno = ss.sno
		and rownum < 4
]]>
	</select>

	<select id="Isinchung_list"
		resultType="com.uni.domain.Sinchung_ListVO">
		<![CDATA[
					select w.title, w.name, w.phone, s.ino, s.reservation
    				  from uni_sinchung s, uni_member m, (select * from uni_workplace_i i, uni_member m where i.mno = m.mno) w where w.ino = s.ino 
     	  			 and m.mno = s.mno and m.mno = #{mno} and rownum<4 order by s.ino
		]]>
	</select>


	<select id="sinchung_list_s_ajax"
		resultType="com.uni.domain.Sinchung_ListVO">
	<![CDATA[
		select aa.*, ss.reservation, ss.mno from (select w.title,
		m.name, m.phone, s.sno
		from uni_sinchung s, uni_member m,
		uni_workplace_s w where w.sno
		= s.sno
		and m.mno = s.mno and flag='d'  order by s.sno asc)
		aa,
		(select s.reservation, s.sno, m.mno
		from uni_sinchung s, uni_member
		m, uni_workplace_s w where w.sno =
		s.sno
		and m.mno = s.mno and flag='s'
		and m.mno = #{mno}  order by s.sno asc) ss
		where aa.sno= ss.sno
		]]>
	</select>


	<select id="sinchung_list_d_ajax"
		resultType="com.uni.domain.Sinchung_ListVO">
	<![CDATA[
		select aa.*, ss.mno from (select w.title, m.name, m.phone,
		s.sno,
		s.reservation
		from uni_sinchung s, uni_member m, uni_workplace_s
		w
		where w.sno = s.sno
		and m.mno = s.mno and flag='d' and m.mno = #{mno}
		order by s.sno asc)
		aa,
		(select
		s.reservation, s.sno, m.mno
		from
		uni_sinchung s, uni_member
		m,
		uni_workplace_s w where w.sno = s.sno
		and
		m.mno = s.mno and flag='s' order by s.sno asc)
		ss
		where aa.sno = ss.sno
]]>
	</select>
	<select id="Isinchung_list_ajax"
		resultType="com.uni.domain.Sinchung_ListVO">
		select w.title, w.name, w.phone, s.ino, s.reservation
		from
		uni_sinchung s, uni_member m, (select * from uni_workplace_i i,
		uni_member m where i.mno = m.mno) w where w.ino = s.ino
		and m.mno =
		s.mno and m.mno = #{mno} order by s.ino

	</select>

	<!-- 로그인한 사람에 대한 작업실 신청 점보 검색 -->
	<select id="sinchungList" resultType="com.uni.domain.SinchungVO">
		select w.title, w.location, w.price, w.name as hname,
		w.phone as hphone,
		m.name as cname, m.phone as cphone, s.ino,
		s.reservation, m.mno
		from uni_sinchung s, uni_member m, (select * from
		uni_workplace_i i,
		uni_member m where i.mno = m.mno) w where w.ino =
		s.ino
		and m.mno = s.mno and s.ino = #{no} order by s.ino
	</select>


</mapper>