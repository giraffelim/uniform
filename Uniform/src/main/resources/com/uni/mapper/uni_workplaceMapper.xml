<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uni.mapper.uni_workplaceMapper">


	<resultMap type="com.uni.domain.uni_workplace_iVO"
		id="leaseMap">
		<id property="ino" column="ino" />
		<result property="title" column="title" />
		<result property="location" column="location" />
		<result property="thumbnail" column="thumbnail" />
		<result property="comforts" column="comforts" />
		<result property="price" column="price" />
		<result property="context" column="context" />
		<result property="rDate" column="rDate" />
		<result property="mno" column="mno" />
		<result property="readCount" column="readCount" />
		<collection property="attachList" resultMap="photoMap">
		</collection>
	</resultMap>

	<resultMap type="com.uni.domain.uni_PhotoVO" id="photoMap">
		<result property="pno" column="pno" />
		<result property="path" column="path" />
		<result property="uuid" column="uuid" />
		<result property="fileName" column="fileName" />
		<result property="ino" column="ino" />
		<result property="sno" column="sno" />
	</resultMap>

	<insert id="insertWorkPlace_i">
		<selectKey keyProperty="ino" order="BEFORE" resultType="int">
			select uni_workplace_i_seq.nextval from dual
		</selectKey>
		insert into uni_workplace_i (ino, title, location, thumbnail,
		comforts, price, context, rDate, mno, readcount)
		values(#{ino},
		#{title}, #{location}, #{thumbnail}, #{comforts}, #{price},
		#{context}, sysdate, #{mno}, 0)
	</insert>

	<select id="read" resultMap="leaseMap">
		select *
		from uni_workplace_I i ,
		uni_photo p
		where i.ino = p.ino and i.ino = #{ino}
	</select>

	<insert id="insertAttach">
		insert into uni_photo (pno, path, uuid, filename,
		ino)
		values(uni_photo_seq.nextval, #{path}, #{uuid}, #{fileName},
		#{ino})
	</insert>

	<update id="updateWorkPlace_i">
		update uni_workplace_i set title = #{title}, location
		= #{location},
		thumbnail = #{thumbnail}, comforts = #{comforts}, price
		= #{price}
		where ino = #{ino}
	</update>

	<delete id="deletePhoto">
		delete from uni_photo where ino =#{ino}
	</delete>



	<select id="workPlaceList"
		resultType="com.uni.domain.uni_workplace_iVO">
		select * from uni_workplace_i
	</select>

	<!-- 임대 작업실 검색 -->
	<select id="workPlaceList_i"
		resultType="com.uni.domain.IWorkPlaceVO">
		select * from uni_workplace_i
		where location like
		'%'||#{location}||'%' order by ino
	</select>

	<!-- 공유 작업실 검색 -->
	<select id="workPlaceList_s"
		resultType="com.uni.domain.SWorkPlaceVO">
		select * from uni_workplace_s
		where location like
		'%'||#{location}||'%' order by sno
	</select>

	<!-- 임대 작업실에 대한 평균 별점 -->
	<select id="avg_star_i" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.ino, i.location from uni_review r full outer join
		uni_workplace_i i on r.ino
		=
		i.ino where i.location like
		'%'||#{location}||'%'
		group by r.ino,
		i.location order by r.ino
	</select>

	<!-- 공유 작업실에 대한 평균 별점 -->
	<select id="avg_star_s" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.sno, s.location from uni_review r full outer join
		uni_workplace_s s on r.sno
		=
		s.sno where s.location like
		'%'||#{location}||'%' group by r.sno,
		s.location order by r.sno
	</select>

	<!-- 공유 핫토픽 -->
	<select id="readHotTopic"
		resultType="com.uni.domain.uni_hotTopicVO">

		select round(avg(r.star)) as star, w.name, w.photo, w.sno,
		w.context, w.thumbnail, w.mno, w.readcount from
		(select m.name,
		m.photo, w.sno,
		w.context,w.thumbnail, m.mno, w.readcount from
		uni_workplace_s w, uni_member m where w.mno = m.mno) w full outer join
		uni_review r
		on w.sno is not null group by w.name, w.photo, w.sno,
		w.context,
		w.thumbnail,
		w.mno, w.readcount order by w.readcount desc


	</select>
	<!-- 임대 핫토픽 -->
	<select id="readHotTopicImde"
		resultType="com.uni.domain.uni_hotTopicVO">


		select round(avg(r.star)) as star, w.name, w.photo, w.ino,
		w.context, w.thumbnail, w.mno, w.readcount from
		(select m.name,
		m.photo, w.ino,
		w.context,w.thumbnail, m.mno, w.readcount from
		uni_workplace_i w, uni_member m where w.mno = m.mno) w full outer join
		uni_review r on w.ino is not null group by w.name, w.photo, w.ino,
		w.context, w.thumbnail,
		w.mno, w.readcount order by w.readcount desc

	</select>

	<select id="getOldFiles" resultType="com.uni.domain.uni_PhotoVO">
		select * from uni_photo
		where path = to_char(sysdate-1, 'yyyy/mm/dd')
	</select>

	<select id="getShinChung"
		resultType="com.uni.domain.uni_ShinChungVO">
		select * from uni_sinchung where ino = #{ino}
	</select>

	<insert id="insertShinChung">
		insert into uni_sinchung(rno, reservation, mno, ino,
		sDate) values (uni_sinchung_seq.nextval,#{reservation},#{mno},#{ino},
		sysdate)
	</insert>

	<select id="getShinChungLike"
		resultType="com.uni.domain.uni_ShinChungVO">
		select * from uni_sinchung where ino = #{ino} and
		reservation like '%'||#{reservation}||'%'
	</select>


	<select id="sinchung_list"
		resultType="com.uni.domain.Sinchung_ListVO">
		select w.title, w.name, w.phone, w.sno, s.reservation,
		s.mno from
		(select w.title, m.name, m.phone, w.sno, m.mno from
		uni_workplace_s w,
		uni_member m where w.mno = m.mno) w, uni_sinchung s
		where w.sno = s.sno and s.mno = #{mno} order by sno asc
	</select>



	<select id="Isinchung_list"
		resultType="com.uni.domain.Sinchung_ListVO">
		<![CDATA[
					select w.title, w.name, w.phone, s.ino, s.reservation
    				  from uni_sinchung s, uni_member m, (select * from uni_workplace_i i, uni_member m where i.mno = m.mno) w where w.ino = s.ino 
     	  			 and m.mno = s.mno and m.mno = #{mno} and rownum<4 order by s.ino
		]]>
	</select>



	<select id="Isinchung_list_ajax"
		resultType="com.uni.domain.Sinchung_ListVO">
		select w.title, w.name, w.phone, s.ino, s.reservation
		from
		uni_sinchung s, uni_member m, (select * from uni_workplace_i i,
		uni_member m where i.mno = m.mno) w where w.ino = s.ino
		and m.mno =
		s.mno and m.mno = #{mno} order by s.ino

	</select>



	<!-- 로그인한 사람에 대한 작업실 신청 정보 검색 -->
	<select id="sinchungList" resultType="com.uni.domain.SinchungVO">
		select w.title, w.location,
		w.price, w.name as hname,
		w.phone as hphone,
		m.name as cname, m.phone as
		cphone, s.ino,
		s.reservation, m.mno
		from uni_sinchung s, uni_member m,
		(select * from
		uni_workplace_i i,
		uni_member m where i.mno = m.mno) w
		where w.ino =
		s.ino
		and m.mno = s.mno and s.ino = #{no} order by s.ino
	</select>

	<!-- 로그인한 사람에 대한 작업실 확정 정보 검색 -->
	<select id="IConfirmList"
		resultType="com.uni.domain.uni_confirmVO">
		select c.cno, w.ino, w.title, w.location, w.thumbnail,
		w.price, w.name, w.phone, c.mytime, c.cname, c.cphone, c.reservation,
		c.mno from uni_confirm c,
		(select w.ino, w.title, w.location,
		w.thumbnail, w.price, m.name, m.phone
		from uni_workplace_i w,
		uni_member m where w.mno = m.mno) w where
		c.ino = w.ino order by c.cno
	</select>

	<select id="SConfirmList"
		resultType="com.uni.domain.uni_confirmVO">
		select c.cno, w.sno, w.title, w.location, w.thumbnail,
		w.price, w.name, w.phone, c.mytime, c.cname, c.cphone, c.reservation,
		c.mno from uni_confirm c,
		(select w.sno, w.title, w.location,
		w.thumbnail, w.price, m.name, m.phone
		from uni_workplace_s w,
		uni_member m where w.mno = m.mno) w where
		c.sno = w.sno order by c.cno
	</select>

	<select id="Sconfirm" resultType="com.uni.domain.uni_confirmVO">
		select c.cno, w.sno, w.title,
		w.location, w.thumbnail, w.mydate,
		w.price, w.name, w.phone, c.mytime,
		c.cname, c.cphone, c.reservation,
		c.mno
		from uni_confirm c,
		(select
		w.sno, w.title, w.location,
		w.thumbnail,
		w.price, w.mydate, m.name,
		m.phone
		from uni_workplace_s w,
		uni_member m
		where w.mno = m.mno) w where
		c.sno = w.sno and c.cno = #{cno}
	</select>

	<select id="Iconfirm" resultType="com.uni.domain.uni_confirmVO">
		select c.cno, w.ino, w.title,
		w.location, w.thumbnail,
		w.price, w.name, w.phone, c.mytime, c.cname,
		c.cphone, c.reservation,
		c.mno from uni_confirm c,
		(select w.ino,
		w.title, w.location, w.thumbnail, w.price, m.name, m.phone
		from
		uni_workplace_i w, uni_member m where w.mno = m.mno) w where
		c.ino =
		w.ino and c.cno = #{cno}
	</select>

	<insert id="Ireview_insert">
		insert into uni_review(hno, content, star, cno, ino,
		mno) values (review_seq.nextval, #{content}, #{star}, #{cno}, #{ino},
		#{mno})
	</insert>

	<insert id="Sreview_insert">
		insert into uni_review(hno, content, star, cno, sno,
		mno) values (review_seq.nextval, #{content}, #{star}, #{cno}, #{sno},
		#{mno})
	</insert>

	<select id="getWorkplaceCount" resultType="int">
		select sum(c.count) as
		sum from (
		select count(*) as count from uni_workplace_i union
		select
		count(*) as count from uni_workplace_s) c
	</select>


</mapper>