<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.uni.mapper.uni_workplaceMapper">


	<resultMap type="com.uni.domain.uni_workplace_iVO" id="leaseMap">
		<id property="ino" column="ino" />
		<result property="title" column="title" />
		<result property="location" column="location" />
		<result property="thumbnail" column="thumbnail" />
		<result property="comforts" column="comforts" />
		<result property="price" column="price" />
		<result property="context" column="context" />
		<result property="rDate" column="rDate" />
		<result property="mno" column="mno" />
		<result property="readCount" column="readCount" />
		<collection property="attachList" resultMap="photoMap">
		</collection>
	</resultMap>
	
	<resultMap type="com.uni.domain.uni_PhotoVO" id="photoMap">
		<result property="pno" column="pno" />
		<result property="path" column="path" />
		<result property="uuid" column="uuid" />
		<result property="fileName" column="fileName" />
		<result property="ino" column="ino" />
		<result property="sno" column="sno" />
	</resultMap>
	
		<insert id="insertWorkPlace_i">
		<selectKey keyProperty="ino" order="BEFORE" resultType="int">
				select uni_workplace_i_seq.nextval from dual
		</selectKey>
		insert into uni_workplace_i (ino, title, location, thumbnail, comforts, price, context, rDate, mno, readcount)
		values(#{ino}, #{title}, #{location}, #{thumbnail}, #{comforts}, #{price}, #{context}, sysdate, #{mno}, 0)
	</insert>
	
	<select id="read" resultMap="leaseMap">
	 	select *
		from uni_workplace_I i , uni_photo p 
		where i.ino = p.ino and i.ino = #{ino}
	</select>
	
	<insert id="insertAttach">
		insert into uni_photo (pno, path, uuid, filename, ino)
		values(uni_photo_seq.nextval, #{path}, #{uuid}, #{fileName}, #{ino})
	</insert>
	
	<update id="updateWorkPlace_i">
	update uni_workplace_i set title = #{title}, location = #{location}, thumbnail = #{thumbnail}, comforts = #{comforts}, price = #{price} where ino = #{ino}
	</update>
	
	<delete id ="deletePhoto">
	delete from uni_photo where ino =#{ino}
	</delete>
	


	<select id="workPlaceList"
		resultType="com.uni.domain.uni_workplace_iVO">
		select * from uni_workplace_i
	</select>

	<select id="workPlaceList_i"
		resultType="com.uni.domain.IWorkPlaceVO">
		select * from uni_workplace_i
		where location like
		'%'||#{location}||'%' order by ino
	</select>

	<select id="workPlaceList_s"
		resultType="com.uni.domain.SWorkPlaceVO">
		select * from uni_workplace_s
		where location like
		'%'||#{location}||'%' order by sno
	</select>

	<select id="avg_star_i" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.ino, i.location from uni_review r join
		uni_workplace_i i on r.ino
		=
		i.ino where i.location like
		'%'||#{location}||'%'
		group by r.ino,
		i.location order by r.ino
	</select>

	<select id="avg_star_s" resultType="com.uni.domain.StarAvgVO">
		select round(avg(star)) as
		avg,
		r.sno, s.location from uni_review r join
		uni_workplace_s s on r.sno
		=
		s.sno where s.location like '%'||#{location}||'%' group by r.sno,
		s.location order by r.sno
	</select>

	<!-- 공유 핫토픽 -->
	<select id="readHotTopic"
		resultType="com.uni.domain.uni_hotTopicVO">

		select round(avg(r.star)) as star, m.name, m.photo,
		w.context,w.thumbnail from
		uni_workplace_s w,uni_review r, uni_member m
		where w.sno = r.sno and
		m.mno = r.mno group by w.sno, w.readcount,
		m.name, m.photo, w.context,
		w.thumbnail order by w.readcount desc

	</select>
	<!-- 임대 핫토픽 -->
	<select id="readHotTopicImde"
		resultType="com.uni.domain.uni_hotTopicVO">

		select round(avg(r.star)) as star, m.name, m.photo,
		w.context, w.thumbnail
		from
		uni_workplace_i w, uni_review r, uni_member
		m where w.ino = r.ino and
		m.mno = r.mno group by w.ino, w.readcount,
		m.name, m.photo,
		w.context,w.thumbnail order by w.readcount desc

	</select>
	
	<select id = "getOldFiles" resultType = "com.uni.domain.uni_PhotoVO">
		select * from uni_photo where path = to_char(sysdate-1, 'yyyy/mm/dd')
	</select>
	
	<select id ="getShinChung" resultType="com.uni.domain.uni_ShinChungVO">
		select * from uni_sinchung where ino = #{ino}
	</select>
	
	<insert id ="insertShinChung">
		insert into uni_sinchung (rno, reservation, mno, ino, sDate)
		values(UNI_SINCHUNG_SEQ.nextval,#{reservation}, #{mno}, #{ino}, sysdate)
	</insert>

</mapper>